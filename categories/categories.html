<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sakura High-End Beauty</title>
  <link rel="stylesheet" href="/header_footer/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
 
  <style>
    /* === CSS CHUNG === */
    body { font-family: 'Playfair Display', serif; background-color: #FFF9F9; color: #6B4C3B; margin: 0; overflow-x: hidden; }
    main { padding: 120px 0 40px; min-height: 60vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3100; overflow: hidden; }
    .firework-particle { position: absolute; width: 100px; height: 100px; border-radius: 50%; opacity: 0; will-change: transform, opacity; animation: firework-burst 1.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0); box-shadow: 0 0 20px rgba(230,166,176,0.8), 0 0 30px rgba(249,198,207,0.5); border: 2px solid #E6A6B0; }
    .firework-particle.pink-1 { background: linear-gradient(45deg, #E6A6B0, #F9C6CF); }
    .firework-particle.pink-2 { background: linear-gradient(45deg, #F9C6CF, #FFF9F9); }
    .firework-particle.pink-3 { background: linear-gradient(45deg, #FADADD, #E6A6B0); }
    .firework-particle.pink-4 { background: linear-gradient(45deg, #FFF9F9, #FADADD); }
    .firework-particle::after { content: ''; position: absolute; top: 50%; left: 50%; width: 15px; height: 15px; background: #F9C6CF; border-radius: 50%; transform: translate(-50%, -50%) scale(0); animation: sparkle 1.2s ease-in-out infinite; }
    @keyframes sparkle { 0%,100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1); opacity: 0.9; } }
    @keyframes firework-burst { 0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 50% { opacity: 0.8; } 100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0.5) rotate(45deg); opacity: 0; } }
   
    /* === CSS B·ªò L·ªåC V√Ä S·∫¢N PH·∫®M === */
    .products-page-container { display: flex; gap: 30px; align-items: flex-start; margin-bottom: 60px; }
    .products-filter-sidebar { flex: 0 0 260px; position: sticky; top: 100px; height: calc(100vh - 120px); overflow-y: auto; padding-right: 15px; z-index: 10; }
    .products-filter-sidebar .filter-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #FADADD; padding-bottom: 10px; margin-bottom: 25px; padding-top: 50px; }
    .products-filter-sidebar .filter-header a { font-size: 13px; color: #aaa; text-decoration: none; transition: color 0.3s ease; }
    .products-filter-sidebar .filter-header a:hover { color: #E6A6B0; }
    .price-range { margin: 15px 0; }
    .price-range input[type="range"] { width: 100%; accent-color: #E6A6B0; }
    .price-values { display: flex; justify-content: space-between; font-size: 13px; color: #888; margin-top: 5px; }
    .checkbox-group { margin: 15px 0; }
    .checkbox-group label { display: block; font-size: 14px; color: #6B4C3B; margin: 8px 0; cursor: pointer; }
    .checkbox-group input[type="checkbox"] { accent-color: #E6A6B0; margin-right: 8px; }
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 30px; width: 100%; }
    .product-card { background: #fff; border: 1px solid rgba(230,166,176,0.3); border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; position: relative; }
    .product-card:hover { transform: translateY(-8px); box-shadow: 0 12px 24px rgba(230,166,176,0.15); border-color: #E6A6B0; }
    .product-image-container { position: relative; overflow: hidden; }
    .product-img { width: 100%; height: 260px; object-fit: cover; transition: opacity 0.4s ease; }
    .hover-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s ease; z-index: 1; }
    .product-card:hover .product-img { opacity: 0; }
    .product-card:hover .hover-image { opacity: 1; }
    .badge { position: absolute; top: 12px; left: 12px; z-index: 2; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-new { background: #E6A6B0; color: white; }
    .badge-sale { background: #FF6B6B; color: white; }
    .info { padding: 16px; flex-grow: 1; display: flex; flex-direction: column; }
    .info h3 { font-size: 1.1rem; margin: 0 0 6px; color: #6B4C3B; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .info p { font-size: 0.9rem; color: #866e6e; margin: 4px 0; flex-grow: 1; }
    .meta { font-size: 0.8rem; color: #9b7c7c; margin: 4px 0; }
    .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f5f5f5; }
    .price { color: #E6A6B0; font-weight: bold; font-size: 1.2rem; }
    .original-price { text-decoration: line-through; color: #aaa; font-size: 0.9rem; margin-left: 6px; }
    .rating { display: flex; align-items: center; font-size: 0.9rem; color: #9b7c7c; }
    .star { width: 16px; height: 16px; color: gold; margin-right: 3px; }
    .buttons { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
    .quantity-input { width: 50px; padding: 6px; border: 1px solid #eee; border-radius: 6px; font-size: 14px; text-align: center; }
    .quantity-input:focus { border-color: #E6A6B0; outline: none; }
    .btn-outline { width: 40px; height: 40px; background: url('../1.homepage/images/shopping.png') no-repeat center center; background-size: 22px; border: 1.5px solid #E6A6B0; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .btn-outline:hover { background-color: #fdf5f5; border-color: #F9C6CF; transform: scale(1.1); }
    .btn-view-details { flex: 1; height: 44px; background: linear-gradient(135deg, #E6A6B0, #F9C6CF); color: white; font-size: 15px; font-weight: 600; border: none; border-radius: 25px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(230,166,176,0.3); position: relative; overflow: hidden; font-family: 'Playfair Display', serif; }
    .btn-view-details::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.4s ease, height 0.4s ease; }
    .btn-view-details:hover { background: linear-gradient(135deg, #F9C6CF, #E6A6B0); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(230,166,176,0.4); }
    .btn-view-details:hover::after { width: 200px; height: 200px; }
   
    /* === CSS SHOP BY CATEGORY (V√≤ng tr√≤n) === */
    .shop-section { margin: 80px 0 60px; text-align: center; position: relative; }
    .shop-title { font-size: 1.8rem; color: #6B4C3B; margin-bottom: 40px; letter-spacing: 1px; }
    .luxury-circles { display: flex; flex-wrap: wrap; justify-content: center; gap: 70px; margin-top: 20px; }
    .circle { position: relative; width: 230px; height: 230px; border-radius: 50%; cursor: pointer; overflow: hidden; background: #fff; box-shadow: 0 0 20px rgba(230,166,176,0.15); transition: all .6s ease; }
    .text { position: absolute; inset: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 600; font-size: 1.3rem; color: #6B4C3B; z-index: 3; background: #fff; transition: opacity .6s ease, transform .5s ease; }
    .circle img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; border-radius: 50%; opacity: 0; transition: all .7s ease; transform: scale(1.1); z-index: 1; }
    .circle::after { content: ""; position: absolute; inset: 0; border-radius: 50%; background: linear-gradient(to top, rgba(230,166,176,0.45), rgba(255,249,249,0.05)); opacity: 0; transition: opacity .6s ease; z-index: 2; }
    .circle::before { content: ""; position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(from 0deg, #E6A6B0, #F9C6CF, #FADADD, #FFF9F9, #E6A6B0); opacity: 0; filter: blur(12px); transition: opacity .6s ease-in-out, transform 1s ease-in-out; z-index: 0; }
    .circle:hover { transform: scale(1.08); box-shadow: 0 0 45px rgba(230,166,176,0.35); }
    .circle:hover::before { opacity: 1; transform: rotate(360deg) scale(1.05); }
    .circle:hover::after { opacity: 1; }
    .circle:hover .text { opacity: 0; transform: scale(0.85); }
    .circle:hover img { opacity: 1; transform: scale(1); filter: brightness(0.9); }
    .circle.active { transform: scale(1.08); box-shadow: 0 0 45px rgba(230,166,176,0.5); }
    .circle.active::before { opacity: 1; transform: rotate(180deg) scale(1.05); }
    .circle.active::after { opacity: 1; }
    .circle.active .text { opacity: 0; transform: scale(0.85); }
    .circle.active img { opacity: 1; transform: scale(1); filter: brightness(0.9); }
    @media (max-width: 768px) { .circle { width: 180px; height: 180px; } .luxury-circles { gap: 30px; } }
   
    /* === CSS SHOP BY BRAND (Canvas) === */
    .shop-grid.brand-canvas { display: grid; grid-template-columns: repeat(4, 1fr); gap: 30px; justify-items: center; align-items: center; margin-top: 40px; perspective: 1200px; }
    @media (max-width: 1200px) { .shop-grid.brand-canvas { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .shop-grid.brand-canvas { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .shop-grid.brand-canvas { grid-template-columns: 1fr; } }
    .canvas { position: relative; width: 250px; height: 250px; padding: 16px; text-decoration: none; color: inherit; opacity: 0; transform: translateY(40px) rotateX(15deg) scale(0.9); animation: brandEnter 1s ease forwards; }
    .canvas:nth-child(1) { animation-delay: 0.1s; }
    .canvas:nth-child(2) { animation-delay: 0.2s; }
    .canvas:nth-child(3) { animation-delay: 0.1s; }
    .canvas:nth-child(4) { animation-delay: 0.1s; }
    @keyframes brandEnter { 0% { opacity: 0; transform: translateY(40px) rotateX(15deg) scale(0.9); } 100% { opacity: 1; transform: translateY(0) rotateX(0deg) scale(1); } }
    .canvas_border { position: absolute; top: 25px; left: -25px; height: 100%; width: 100%; z-index: 0; transform: rotate(-10deg) skew(-10deg); transition: all 0.35s ease-in-out; }
    .canvas_border svg { height: 100%; width: 100%; }
    .canvas_border rect { fill: none; stroke: url(#grad-pink); stroke-width: 3; stroke-dasharray: 1500; stroke-dashoffset: 1500; animation: erase-line 1s ease-in-out forwards; }
    @keyframes erase-line { from { stroke-dashoffset: 0; } to { stroke-dashoffset: 1500; } }
    @keyframes draw-line { from { stroke-dashoffset: 1500; } to { stroke-dashoffset: 0; } }
    .canvas_img-wrapper { position: absolute; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; top: 0; left: 0; overflow: hidden; transform: rotate(-10deg) skew(-10deg); background: #fff; border-radius: 16px; transition: all 0.35s ease; box-shadow: 0 4px 12px rgba(230,166,176,0.2); }
    .canvas_img { transform: scale(0.9); opacity: 0.4; max-width: 140px; max-height: 140px; transition: all 0.4s ease; object-fit: contain; }
    .canvas_copy { position: absolute; bottom: 10px; right: -16%; text-transform: uppercase; color: #6B4C3B; z-index: 2; opacity: 0; transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .canvas_copy_subtitle { font-size: 0.8rem; letter-spacing: 1px; color: #E6A6B0; }
    .canvas_copy_title { font-size: 1.3rem; font-weight: 700; color: #6B4C3B; display: block; animation: heartbeat 2.2s ease-in-out infinite; }
    @keyframes heartbeat { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .canvas:hover .canvas_border rect { animation: draw-line 1.8s ease-in-out forwards; stroke-width: 4; }
    .canvas:hover .canvas_border, .canvas:hover .canvas_img-wrapper { transform: rotate(-14deg) skew(-14deg) scale(1.04); box-shadow: 0 8px 20px rgba(230,166,176,0.35); }
    .canvas:hover .canvas_img { transform: scale(1.08); opacity: 0.9; filter: brightness(1.15) saturate(1.1); }
    .canvas:hover .canvas_copy { opacity: 1; right: -8%; }
    .canvas:hover::before { content: ""; position: absolute; top: 0; left: -100%; width: 200%; height: 100%; background: linear-gradient(120deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.15) 100%); transform: skewX(-20deg); animation: shimmer 2s infinite; border-radius: 16px; z-index: 3; pointer-events: none; }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
   
        .menu-toggler,
    .category-header .next-btn {  display: none; }
    @media (max-width: 900px) {
      .menu-toggler {
        display: block; 
        background: none; border: none; cursor: pointer;
        z-index: 1001;
      }
      .menu-toggler img { width: 24px; }
      .navbar {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100vh; 
        background: #FFF9F9;
        flex-direction: column;
        align-items: center; justify-content: center;
        padding-top: 60px;
        z-index: 1000;
        overflow-y: auto; 
      }
      .navbar.active {
        display: flex;
      }
      .navbar a {
        font-size: 1.5rem; margin: 15px 0; color: #6B4C3B;
      }
      .menu-categories { width: 100%; text-align: center; }
      .category-header { display: flex; align-items: center; justify-content: center; position: relative; width: 100%; }
      .category-header h3 a { font-size: 1.5rem; margin: 15px 0; }
      .category-header .next-btn {
        display: block; background: none; border: none; cursor: pointer;
        padding: 10px; position: absolute; right: 20%;
        transition: transform 0.3s ease;
      }
      .category-header .next-btn.active { transform: rotate(90deg); }
      .category-header .next-btn img { width: 16px; }
      .product-list { display: none; background: #fff; padding: 10px 0; width: 100%; }
      .product-list.active { display: block; }
      .product-list li { font-size: 1rem; padding: 8px 0; color: #866e6e; }
    }
    /* === CSS CHO OVERLAY T√åM KI·∫æM === */
    .search-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 2000;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .search-overlay.active { opacity: 1; pointer-events: auto; }
    .search-overlay .search-wrapper { display: flex; align-items: center; width: 80%; max-width: 600px; border-bottom: 2px solid #333; }
    .search-overlay .search-wrapper input { width: 100%; border: none; outline: none; background: transparent; font-size: 1.5rem; padding: 10px; }
    .search-overlay .icon { width: 24px; height: 24px; opacity: 0.5; margin-right: 10px; }
    .search-overlay .close-search { background: none; border: none; cursor: pointer; padding: 10px; }
    .search-overlay .close-search img { width: 20px; height: 20px; }
  </style>
 
</head>
<body>
  <div class="fireworks-container"></div>
  <div id="header-placeholder"><div style="text-align:center; padding: 20px; color:#aaa;">Loading Header...</div></div>
  <main>
    <div class="container">
      <!-- Search Results Section (shown when URL has ?q=...) -->
      <section id="search-results-section" style="display:none; margin-bottom: 40px;">
        <h2 style="text-align:center;margin-bottom:20px;">Search Results</h2>
        <div class="products-grid" id="search-results-grid"></div>
        <div id="search-view-more" style="text-align:center; margin-top:12px; display:none;">
          <a href="#" id="search-view-more-link" style="color:#E6A6B0; font-weight:600; text-decoration:none;">View more results</a>
        </div>
      </section>
            <div class="products-page-container">
        <aside class="products-filter-sidebar">
          <div class="filter-header">
            <h3>FILTER</h3>
            <a href="#" id="clearFilters">Clear All</a>
          </div>
          <div class="filter-group">
            <h4>CATEGORY</h4>
            <div class="luxury-circles" id="categoryCircles"></div>
          </div>
          <div class="filter-group">
            <h4>PRICE RANGE</h4>
            <div class="price-range">
              <input type="range" min="0" max="300" value="300" id="priceSlider">
              <div class="price-values">
                <span>$0</span>
                <span id="priceValue">$300</span>
              </div>
            </div>
          </div>
          <div class="filter-group">
            <h4>BRAND</h4>
            <div class="checkbox-group" id="brandFilters"></div>
          </div>
        </aside>
        <section style="flex:1;">
          <h2 style="text-align:center;margin-bottom:20px;">All Products</h2>
          <div style="text-align:center;margin-bottom:15px;">
            <p id="productCount">Loading products...</p>
          </div>
          <div class="products-grid" id="products-grid">
            <p style="text-align:center;">Loading products...</p>
          </div>
          <div id="category-view-more" style="text-align:center; margin-top:12px; display:none;">
            <a href="#" id="category-view-more-link" style="color:#999; font-weight:600; text-decoration:none;">View more</a>
          </div>
        </section>
      </div>
            <section class="shop-section">
        <h2 class="shop-title">Shop By Brand</h2>
        <div class="shop-grid brand-canvas" id="brandGrid"></div>
      </section>
    </div>
  </main>
  <div id="footer-placeholder"><div style="text-align:center; padding: 20px; color:#aaa;">Loading Footer...</div></div>
<script src="/header_footer/partials.js"></script>
<script>
// === KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C (GLOBAL SCOPE) ===
// S·ª≠a l·ªói nghi√™m tr·ªçng: Di chuy·ªÉn c√°c bi·∫øn n√†y ra ngo√†i ƒë·ªÉ m·ªçi h√†m ƒë·ªÅu truy c·∫≠p ƒë∆∞·ª£c
let pageCart = JSON.parse(localStorage.getItem('cart') || '[]');
let allProducts = [];
let currentFilters = { category: 'ALL-IN', brand: null, price: 300 };
const DEFAULT_IMAGE_PATH = '/header_footer/images/LOGO.png';
const DEFAULT_BRAND_IMAGE_PATH = '/header_footer/images/LOGO.png';
const TOP_SEARCH_RESULTS = 8;

// === H√ÄM H·ªñ TR·ª¢ (HELPERS) ===
function updateCartCount() {
    const cartData = JSON.parse(localStorage.getItem('cart') || '[]');
    const count = cartData.reduce((sum, item) => sum + item.qty, 0);
    const cartIcon = document.querySelector('.cart-count');
    if (cartIcon) cartIcon.textContent = count;
}

function getValidImageUrl(path) {
  if (!path) return DEFAULT_BRAND_IMAGE_PATH; // ·∫¢nh m·∫∑c ƒë·ªãnh
  if (path.startsWith('./images/')) return path.replace('./images/', '../images/');
  return path;
}
function triggerFireworks() {
  const container = document.querySelector('.fireworks-container');
  for (let i = 0; i < 8; i++) {
    const p = document.createElement('div');
    p.className = `firework-particle pink-${(i % 4) + 1}`;
    const a = (Math.PI * 2 * i) / 8;
    const d = 120 + Math.random() * 180;
    p.style.setProperty('--tx', `${Math.cos(a) * d}px`);
    p.style.setProperty('--ty', `${Math.sin(a) * d}px`);
    container.appendChild(p);
    setTimeout(() => p.remove(), 1800);
  }
}
// === H√ÄM KH·ªûI T·∫†O S·ª∞ KI·ªÜN (EVENT HANDLERS) ===
function initHeaderEvents() {
  console.log('üîÑ Initializing header events...');
 
  const menuToggler = document.querySelector('.menu-toggler');
  const navbar = document.querySelector('.navbar');
  const searchIcon = document.querySelector('.search .icon');
  const searchOverlay = document.getElementById('searchOverlay');
  const closeSearch = document.querySelector('.close-search');
  const shopAll = document.querySelector('.shop-all');
  const menuCategories = document.querySelector('.menu-categories');
  const nextBtns = document.querySelectorAll('.next-btn');
  // üü¢ Mobile menu toggle
  if (menuToggler && navbar) {
    // Ph·∫£i d√πng .cloneNode v√† .replaceWith ƒë·ªÉ x√≥a c√°c event listener c≈©
    const newMenuToggler = menuToggler.cloneNode(true);
    menuToggler.parentNode.replaceChild(newMenuToggler, menuToggler);
   
    newMenuToggler.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('üì± Menu toggler clicked');
      navbar.classList.toggle('active');
      document.body.style.overflow = navbar.classList.contains('active') ? 'hidden' : '';
    });
  } else {
    console.warn('Menu toggler or navbar not found');
  }
  // üü¢ Shop All dropdown
  if (shopAll && menuCategories) {
    shopAll.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      menuCategories.classList.toggle('active');
      shopAll.classList.toggle('active');
    });
  }
  // üü¢ Search functionality
  if (searchIcon && searchOverlay) {
    searchIcon.addEventListener('click', () => {
      searchOverlay.classList.add('active');
    });
  }
  if (closeSearch && searchOverlay) {
    closeSearch.addEventListener('click', () => {
      searchOverlay.classList.remove('active');
    });
  }
  // üü¢ Next buttons in categories
  nextBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const list = btn.closest('.category').querySelector('.product-list');
      btn.classList.toggle('active');
      list.classList.toggle('active');
    });
  });
  // üü¢ Close menus when clicking outside
  document.addEventListener('click', (e) => {
    if (navbar && navbar.classList.contains('active') &&
        !navbar.contains(e.target) &&
        !e.target.closest('.menu-toggler')) {
      navbar.classList.remove('active');
      document.body.style.overflow = '';
    }
    if (menuCategories && menuCategories.classList.contains('active') &&
        !menuCategories.contains(e.target) &&
        !e.target.closest('.shop-all')) {
      menuCategories.classList.remove('active');
      if (shopAll) shopAll.classList.remove('active');
    }
    if (searchOverlay && searchOverlay.classList.contains('active') &&
        !searchOverlay.contains(e.target) &&
        !e.target.closest('.search .icon')) {
      searchOverlay.classList.remove('active');
    }
  });
  if (navbar) navbar.addEventListener('click', (e) => e.stopPropagation());
  if (menuCategories) menuCategories.addEventListener('click', (e) => e.stopPropagation());
  console.log('‚úÖ Header events initialized successfully');
}
function setupFilterEvents() {
  console.log('üîÑ Initializing filter events...');
  document.querySelectorAll('#categoryCircles .circle').forEach(circle => {
    circle.addEventListener('click', () => {
      const value = circle.getAttribute('data-value');
      currentFilters.category = value;
      document.querySelectorAll('#categoryCircles .circle').forEach(c => c.classList.remove('active'));
      circle.classList.add('active');
      applyFilters();
      updateCount();
      triggerFireworks();
      window.scrollTo({ top: document.querySelector('.products-page-container').offsetTop - 100, behavior: 'smooth' });
    });
  });
  document.getElementById('clearFilters').addEventListener('click', e => {
    e.preventDefault();
    currentFilters = { category: 'ALL-IN', brand: null, price: 300 };
    document.querySelectorAll('#categoryCircles .circle').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('#brandFilters input').forEach(cb => cb.checked = false);
    document.getElementById('priceSlider').value = 300;
    document.getElementById('priceValue').textContent = '$300';
    applyFilters();
    updateCount();
  });
  const slider = document.getElementById('priceSlider');
  const valueEl = document.getElementById('priceValue');
  slider.addEventListener('input', () => {
    currentFilters.price = slider.value;
    valueEl.textContent = `$${slider.value}`;
    applyFilters();
    updateCount();
  });
  document.querySelectorAll('#brandFilters input').forEach(cb => {
    cb.addEventListener('change', () => {
      const checked = Array.from(document.querySelectorAll('#brandFilters input:checked')).map(c => c.value);
      currentFilters.brand = checked.length === 1 ? checked[0] : null;
      applyFilters();
      updateCount();
    });
  });
  console.log('‚úÖ Filter events initialized.');
}
// === H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU (DATA HANDLERS) ===
async function loadProducts() {
  try {
    // H·ª£p nh·∫•t d·ªØ li·ªáu t·ª´ nhi·ªÅu ngu·ªìn ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ ƒë·ªß s·∫£n ph·∫©m cho m·ªói category
    const sources = [
      { url: '/categories/full.json', base: '/categories' },
      { url: '/Best_Sellers/full.json', base: '/Best_Sellers' },
      { url: '/Sale/products.json', base: '/Sale' },
      { url: '/new/products.json', base: '/new' }
    ];

    const normalizeImagePath = (p, base) => {
      if (!p) return p;
      if (typeof p === 'string' && p.startsWith('./images/')) {
        return p.replace('./images/', `${base}/images/`);
      }
      if (typeof p === 'string' && p.startsWith('images/') && base === '/Sale') {
        return `${base}/${p}`;
      }
      return p; // Gi·ªØ nguy√™n URL tuy·ªát ƒë·ªëi ho·∫∑c c√°c tr∆∞·ªùng h·ª£p kh√°c
    };

    const normalizeBrandImage = (b, base) => {
      if (!b) return b;
      if (typeof b === 'string' && b.startsWith('./images/')) {
        return b.replace('./images/', `${base}/images/`);
      }
      if (typeof b === 'string' && b.startsWith('images/') && base === '/Sale') {
        return `${base}/${b}`;
      }
      return b;
    };

    const results = await Promise.allSettled(
      sources.map(s => fetch(s.url).then(r => r.json()).then(d => ({ data: d, base: s.base })))
    );

    let merged = [];
    for (const r of results) {
      if (r.status === 'fulfilled') {
        const { data, base } = r.value;
        const list = (data.products || []).map(prod => ({
          ...prod,
          brandImage: normalizeBrandImage(prod.brandImage, base),
          images: Array.isArray(prod.images) ? prod.images.map(img => normalizeImagePath(img, base)) : prod.images
        }));
        merged = merged.concat(list);
      }
    }
    // Lo·∫°i b·ªè tr√πng theo brand + name (∆∞u ti√™n b·∫£n ƒë·∫ßu ti√™n g·∫∑p)
    const seenKeys = new Set();
    allProducts = merged.filter(p => {
      const key = `${normalizeText(p.brand)}|${normalizeText(p.name)}`;
      if (seenKeys.has(key)) return false;
      seenKeys.add(key);
      return true;
    });
    // S·ª¨A L·ªñI: B·ªè comment kh·ªëi n√†y
    const brands = [...new Set(allProducts.map(p => p.brand).filter(Boolean))].sort();
    const brandContainer = document.getElementById('brandFilters');
    brandContainer.innerHTML = brands.map(brand => `
      <label><input type="checkbox" value="${brand}"> ${brand}</label>
    `).join('');
    const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
    const catContainer = document.getElementById('categoryCircles');
    catContainer.innerHTML = "";
    categories.forEach((cat, index) => {
      const prod = allProducts.find(p => p.category === cat);
      const img = prod?.images?.[0] || DEFAULT_IMAGE_PATH;
      const html = `
        <div class="circle" data-value="${cat}" style="animation-delay: ${index * 0.1}s;">
         <img src="${img}" alt="${cat}" onerror="this.src='${DEFAULT_IMAGE_PATH}'">
         <div class="text"><h3>${cat}</h3></div>
       </div>`;
      catContainer.insertAdjacentHTML('beforeend', html);
    });
    const brandGrid = document.getElementById('brandGrid');
    brandGrid.innerHTML = "";
    const uniqueBrands = [...new Map(
      allProducts.map(p => [p.brand, { name: p.brand, logo: p.brandImage }])
    ).values()].filter(b => b.logo);
    uniqueBrands.forEach((brand, i) => {
      const logoImg = getValidImageUrl(brand.logo); // D√πng h√†m helper
      const safeId = `grad-${encodeURIComponent(brand.name)}-${i}`;
      const html = `
        <a href="#" class="canvas" data-brand="${brand.name}" onclick="filterByBrand('${brand.name}')">
         <div class="canvas_border">
           <svg><defs>
             <linearGradient id="${safeId}" x1="0%" y1="0%" x2="100%" y2="0%">
               <stop offset="0%" stop-color="#E6A6B0"></stop>
               <stop offset="100%" stop-color="#F9C6CF"></stop>
             </linearGradient>
           </defs>
           <rect width="100%" height="100%" fill="none" stroke="url(#${safeId})" stroke-width="4"/>
         </svg>
         </div>
          <div class="canvas_img-wrapper">
           <img class="canvas_img" src="${logoImg}" alt="${brand.name}" onerror="this.src='${DEFAULT_BRAND_IMAGE_PATH}'">
         </div>
         <div class="canvas_copy">
           <span class="canvas_copy_subtitle">Luxury Brand</span>
           <strong class="canvas_copy_title">${brand.name}</strong>
         </div>
       </a>`;
      brandGrid.insertAdjacentHTML('beforeend', html);
    });
    renderProducts(allProducts);
    updateCount();
    setupFilterEvents(); // ƒê·ªïi t√™n h√†m
  } catch (err) {
    console.error('‚ùå L·ªói t·∫£i s·∫£n ph·∫©m chi ti·∫øt:', err);
    document.getElementById('products-grid').innerHTML =
      '<p style="color:red;text-align:center;">L·ªói t·∫£i s·∫£n ph·∫©m</p>';
  }
}
// Render products into a specific grid element
function renderProductsToGrid(list, gridEl) {
  if (!gridEl) return;
  if (!list || list.length === 0) {
    gridEl.innerHTML = '<p style="text-align:center; color:#aaa;">No products found.</p>';
    return;
  }
  const html = list.map(p => {
    const img1 = p.images?.[0] || DEFAULT_IMAGE_PATH;
    const img2 = p.images?.[1] || img1;
    const hasSale = p.originalPrice && p.originalPrice > p.price;
    const isNew = p.isNew === true;
    return `
      <div class="product-card">
        <div class="product-image-container">
          ${isNew ? `<span class="badge badge-new">NEW</span>` : ''}
          ${hasSale ? `<span class="badge badge-sale">SALE</span>` : ''}
          <img src="${img1}" alt="${p.name}" class="product-img" onerror="this.src='${DEFAULT_IMAGE_PATH}'">
          <img src="${img2}" alt="${p.name}" class="hover-image" onerror="this.src='${img1}'">
        </div>
        <div class="info">
          <h3 title="${p.name}">${p.name}</h3>
          <p>${p.description || ''}</p>
          <div class="meta">SKU: ${p.id} ‚Ä¢ ${p.brand}</div>
          <div class="actions">
            <div><span class="price">$${Number(p.price || 0).toFixed(2)}</span>${hasSale ? `<span class="original-price">$${Number(p.originalPrice).toFixed(2)}</span>` : ''}</div>
            <div class="rating"><i class="fas fa-star star"></i> ${p.rating?.toFixed(1) || '0.0'}</div>
          </div>
          <div class="buttons">
            <button class="btn-outline" onclick="addToCart(${p.id}, this)"></button>
            <button class="btn-view-details" onclick="viewDetail(${p.id})"><span>View Details</span></button>
          </div>
        </div>
      </div>`;
  }).join('');
  gridEl.innerHTML = html;
}
function renderProducts(list) {
  const grid = document.getElementById('products-grid');
  if (!list || list.length === 0) {
    grid.innerHTML = '<p style="text-align:center; color:#aaa;">No products found.</p>';
    return;
  }
  const html = list.map(p => {
    const img1 = p.images?.[0] || DEFAULT_IMAGE_PATH;
    const img2 = p.images?.[1] || img1;
    const hasSale = p.originalPrice && p.originalPrice > p.price;
    const isNew = p.isNew === true;
    return `
      <div class="product-card">
        <div class="product-image-container">
          ${isNew ? `<span class="badge badge-new">NEW</span>` : ''}
          ${hasSale ? `<span class="badge badge-sale">SALE</span>` : ''}
          <img src="${img1}" alt="${p.name}" class="product-img" onerror="this.src='${DEFAULT_IMAGE_PATH}'">
          <img src="${img2}" alt="${p.name}" class="hover-image" onerror="this.src='${img1}'">
        </div>
        <div class="info">
          <h3 title="${p.name}">${p.name}</h3>
          <p>${p.description || ''}</p>
          <div class="meta">SKU: ${p.id} ‚Ä¢ ${p.brand}</div>
          <div class="actions">
            <div><span class="price">$${Number(p.price || 0).toFixed(2)}</span>${hasSale ? `<span class="original-price">$${Number(p.originalPrice).toFixed(2)}</span>` : ''}</div>
            <div class="rating"><i class="fas fa-star star"></i> ${p.rating?.toFixed(1) || '0.0'}</div>
          </div>
          <div class="buttons">
            <button class="btn-outline" onclick="addToCart(${p.id}, this)"></button>
            <button class="btn-view-details" onclick="viewDetail(${p.id})"><span>View Details</span></button>
          </div>
        </div>
      </div>`;
  }).join('');
  grid.innerHTML = html;
}
function updateCount() {
  const filtered = applyFilters(); // S·∫Ω g·ªçi applyFilters 1 l·∫ßn
  document.getElementById('productCount').textContent = `${filtered.length} product${filtered.length !== 1 ? 's' : ''}`;
}
function applyFilters() {
  let result = [...allProducts]; // D√πng bi·∫øn global
  if (currentFilters.category && currentFilters.category !== 'ALL-IN') { // D√πng bi·∫øn global
    result = result.filter(p => p.category === currentFilters.category);
  }
  if (currentFilters.subtype) {
    const sub = String(currentFilters.subtype).toLowerCase();
    result = result.filter(p => String(p.subtype || '').toLowerCase() === sub);
  }
  if (currentFilters.brand) { // D√πng bi·∫øn global
    result = result.filter(p => p.brand === currentFilters.brand);
  }
  result = result.filter(p => p.price <= currentFilters.price);
  renderProducts(result);
  return result;
}
// === C√ÅC H√ÄM T∆Ø∆†NG T√ÅC (ACTIONS) ===
window.addToCart = (id, btn) => {
  const product = allProducts.find(p => p.id === id); // D√πng bi·∫øn global
  if (!product) return;
  const existing = pageCart.find(item => item.id === id); // D√πng bi·∫øn global
  if (existing) existing.qty += 1;
  else pageCart.push({ ...product, qty: 1 });
  localStorage.setItem('cart', JSON.stringify(pageCart));
  updateCartCount();
  triggerFireworks();
  alert(`${product.name} ƒë√£ th√™m v√†o gi·ªè!`);
};
window.viewDetail = (id) => {
  window.location.href = `/src/pages/categories/categories_detail.html?id=${id}`;
};
window.filterByBrand = (brandName) => {
  currentFilters.brand = brandName; // G√°n v√†o bi·∫øn global
  document.querySelectorAll('#brandFilters input').forEach(cb => cb.checked = false);
  const cb = document.querySelector(`#brandFilters input[value="${brandName}"]`);
  if (cb) cb.checked = true;
  applyFilters();
  updateCount();
  triggerFireworks();
};
// === H√ÄM KH·ªûI CH·∫†Y CH√çNH (MAIN EXECUTION) ===
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Starting application...');
 
  const headerPlaceholder = document.getElementById('header-placeholder');
  const observer = new MutationObserver((mutationsList, observer) => {
      for(let mutation of mutationsList) {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              if (headerPlaceholder.querySelector('.header')) {
                  console.log('Header loaded, initializing events and cart count.');
                  initHeaderEvents();
                  updateCartCount();
                  observer.disconnect(); 
                  break;
              }
          }
      }
  });
  observer.observe(headerPlaceholder, { childList: true, subtree: true });

  // C·∫≠p nh·∫≠t gi·ªè h√†ng ngay l·∫≠p t·ª©c v√† sau ƒë√≥ khi header ƒë∆∞·ª£c t·∫£i
  updateCartCount();
  // T·∫£i s·∫£n ph·∫©m (h√†m n√†y s·∫Ω t·ª± ƒë·ªông g·ªçi render, updateCount, v√† setupFilterEvents)
  await loadProducts();
});
</script>
</body>
</html>
