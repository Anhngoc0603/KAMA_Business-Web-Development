<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sakura Beauty - Category Carousel</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body { 
      font-family: 'Playfair Display', serif;
      background: #FFF9F9;
      color: #6B4C3B;
      margin: 0;
      overflow-x: hidden; /* Ngăn cuộn ngang không cần thiết */
    }
    
    main { 
      padding-top: 120px; 
      min-height: 80vh; 
      box-sizing: border-box;
    }

    /* Placeholder cho Header/Footer */
    #header-placeholder, #footer-placeholder {
      width: 100%;
    }
    
    /*--------------------
      CSS Carousel
    --------------------*/
    .carousel {
      position: relative;
      z-index: 1;
      height: 80vh; 
      overflow: hidden;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .carousel-loading {
      font-size: 1.2rem;
      color: #E6A6B0;
    }

    .carousel-item {
      --items: 10; 
      --width: clamp(200px, 30vw, 300px);
      --height: clamp(300px, 45vw, 450px);
      --x: calc(var(--active) * 800%);
      --y: calc(var(--active) * 200%);
      --rot: calc(var(--active) * 120deg);
      --opacity: calc(var(--zIndex) / var(--items) * 3 - 2);
      overflow: hidden;
      position: absolute;
      z-index: var(--zIndex);
      width: var(--width);
      height: var(--height);
      margin: calc(var(--height) * -0.5) 0 0 calc(var(--width) * -0.5);
      border-radius: 16px; 
      top: 50%;
      left: 50%;
      user-select: none;
      transform-origin: 0% 100%;
      box-shadow: 0 10px 50px 10px rgba(230, 166, 176, .2);
      background: #fff; 
      pointer-events: all;
      transform: translate(var(--x), var(--y)) rotate(var(--rot));
      transition: transform .8s cubic-bezier(0, 0.02, 0, 1);
    }

    .carousel-item .carousel-box {
      position: absolute;
      z-index: 1;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      transition: opacity .8s cubic-bezier(0, 0.02, 0, 1);
      opacity: var(--opacity);
      font-family: 'Playfair Display', serif; 
    }

    .carousel-box:before {
      content: '';
      position: absolute;
      z-index: 1;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0, 0, 0, .0), rgba(0, 0, 0, 0) 30%, rgba(107, 76, 59, .2) 50%, rgba(107, 76, 59, .4));
    }

    .title {
      position: absolute;
      z-index: 1;
      color: #fff; 
      bottom: 20px;
      left: 20px;
      transition: opacity .8s cubic-bezier(0, 0.02, 0, 1);
      font-size: clamp(24px, 3vw, 34px); 
      text-shadow: 0 2px 4px rgba(0, 0, 0, .3);
      font-weight: 600;
      font-family: 'Playfair Display', serif; 
    }

    .num {
      position: absolute;
      z-index: 1;
      color: #E6A6B0;
      opacity: 0.8;
      top: 15px;
      left: 20px;
      transition: opacity .8s cubic-bezier(0, 0.02, 0, 1);
      font-size: clamp(20px, 10vw, 70px); 
      font-family: 'Playfair Display', serif; 
      font-weight: 700;
    }

    .carousel-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      border-radius: 16px;
    }
    
    /*--------------------
      Con trỏ chuột
    --------------------*/
    .cursor {
      position: fixed;
      z-index: 10000; 
      top: 0;
      left: 0;
      --size: 40px;
      width: var(--size);
      height: var(--size);
      border-radius: 50%;
      border: 1px solid #E6A6B0; 
      margin: calc(var(--size) * -0.5) 0 0 calc(var(--size) * -0.5);
      transition: transform .85s cubic-bezier(0, 0.02, 0, 1);
      display: none;
      pointer-events: none;
    }

    .cursor2 {
      --size: 3px; 
      background: #E6A6B0; 
      border: none; 
      transition-duration: .7s;
    }
    
    @media (pointer: fine) {
      .cursor {
        display: block;
      }
    }
  </style>
</head>
<body>

  <div id="header-placeholder">
    <div style="text-align:center; padding: 20px; color:#aaa;">Loading Header...</div>
  </div>

  <main>
    <div class="carousel">
      <div class="carousel-loading">Loading Categories...</div>
          </div>
  </main>
  
  <div id="footer-placeholder">
    <div style="text-align:center; padding: 20px; color:#aaa;">Loading Footer...</div>
  </div>

    <div class="cursor"></div>
  <div class="cursor cursor2"></div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {

      // --- 1. TẢI HEADER & FOOTER ---
      const loadHTML = async (url, id) => {
        const el = document.getElementById(id);
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to load ${url}: ${res.status} ${res.statusText}`);
          el.innerHTML = await res.text();
        } catch (err) {
          el.innerHTML = `<p style="color:red;text-align:center;">Error loading content from ${url}.</p>`;
          console.error(err);
        }
      };

      await Promise.all([
        loadHTML('./header.html', 'header-placeholder'),
        loadHTML('./footer.html', 'footer-placeholder')
      ]);

      // --- 2. CẬP NHẬT GIỎ HÀNG (CHO HEADER) ---
      const updateCartCount = () => {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const count = cart.reduce((sum, item) => sum + item.qty, 0);
        const cartIcon = document.querySelector('.cart-count');
        if (cartIcon) cartIcon.textContent = count;
      };
      updateCartCount();

      // --- 3. TẢI VÀ TẠO CAROUSEL ---
      async function loadCategoryCarousel() {
        const carouselContainer = document.querySelector('.carousel');
        try {
          const res = await fetch('./full.json');
          if (!res.ok) throw new Error(`Failed to fetch full.json: ${res.status} ${res.statusText}`);

          const data = await res.json();
          const products = data.products;
          
          if (!Array.isArray(products)) throw new Error('full.json is missing the "products" array.');

          // Lấy các danh mục duy nhất
          const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
          
          carouselContainer.innerHTML = ''; // Xóa chữ "Loading..."
          
          if (categories.length === 0) {
            carouselContainer.innerHTML = '<div class="carousel-loading">No categories found in data.</div>';
            return;
          }


          categories.forEach((cat, index) => {
            const catProduct = products.find(p => p.category === cat);
            const img = catProduct?.images?.[0] || 'https://via.placeholder.com/300x450/FADADD/FFFFFF?text=No+Image';
            const num = (index + 1).toString().padStart(2, '0');

            const item = document.createElement('div');
            item.className = 'carousel-item';
            item.innerHTML = `
              <div class="carousel-box">
                <div class="title">${cat}</div>
                <div class="num">${num}</div>
                <img src="${img}" alt="${cat}" />
              </div>
            `; 
            carouselContainer.appendChild(item);
          });
          
          // Sau khi tạo HTML xong, khởi tạo logic carousel
          initCarousel();

        } catch (err) {
          carouselContainer.innerHTML = `<div class="carousel-loading" style="color:red;">Error loading categories: ${err.message}</div>`;
          console.error(err);
        }
      }
      
      // --- 4. LOGIC CAROUSEL GỐC (ĐÃ SỬA LỖI LOGIC CLICK) ---
      function initCarousel() {
        let progress = 50;
        let startX = 0;
        let active = 0;
        let isDown = false;

        const speedWheel = 0.02;
        const speedDrag = -0.1;
        
        // Phải lấy $items SAU KHI đã tạo
        const $items = document.querySelectorAll('.carousel-item');
        const $cursors = document.querySelectorAll('.cursor');
        
        // Cập nhật biến --items cho CSS
        $items.forEach(item => {
          item.style.setProperty('--items', $items.length);
        }); 

        const getZindex = (array, index) => (array.map((_, i) => (index === i) ? array.length : array.length - Math.abs(index - i)))

        const displayItems = (item, index, active) => {
          const zIndex = getZindex([...$items], active)[index]
          item.style.setProperty('--zIndex', zIndex)
          item.style.setProperty('--active', (index - active) / $items.length)
        }

        const animate = () => {
          progress = Math.max(0, Math.min(progress, 100))
          // Đảm bảo active không vượt quá giới hạn mảng
          active = Math.floor(progress / 100 * ($items.length - 1))
          $items.forEach((item, index) => displayItems(item, index, active))
        }
        animate()

        $items.forEach((item, i) => {
          item.addEventListener('click', () => {
            // ĐÃ SỬA: Tính toán progress chính xác hơn khi click
            const totalItems = $items.length > 1 ? $items.length - 1 : 1;
            progress = (i / totalItems) * 100;
            animate()
          })
        })

        const handleWheel = e => {
          const wheelProgress = e.deltaY * speedWheel
          progress = progress + wheelProgress
          animate()
        }

        const handleMouseMove = (e) => {
          if (e.type === 'mousemove') {
            $cursors.forEach(($cursor) => {
              $cursor.style.transform = `translate(${e.clientX}px, ${e.clientY}px)`
            }) 
          }
          if (!isDown) return
          const x = e.clientX || (e.touches && e.touches[0].clientX) || 0
          const mouseProgress = (x - startX) * speedDrag
          progress = progress + mouseProgress
          startX = x
          animate()
        }

        const handleMouseDown = e => {
          isDown = true
          startX = e.clientX || (e.touches && e.touches[0].clientX) || 0
        }

        const handleMouseUp = () => {
          isDown = false
        }

        document.addEventListener('mousewheel', handleWheel)
        document.addEventListener('mousedown', handleMouseDown)
        document.addEventListener('mousemove', handleMouseMove)
        document.addEventListener('mouseup', handleMouseUp)
        document.addEventListener('touchstart', handleMouseDown)
        document.addEventListener('touchmove', handleMouseMove)
        document.addEventListener('touchend', handleMouseUp)
      }
      
      // --- 5. CHẠY ---
      await loadCategoryCarousel();
      
    });
  </script>

</body>
</html>